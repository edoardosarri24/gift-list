version: '3.8'

services:
  frontend:
    image: ghcr.io/edoardosarri24/gift-list-frontend:main
    restart: always
    environment:
      - VITE_API_BASE_URL=https://liste.edoardosarri.com/api/v1
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    image: ghcr.io/edoardosarri24/gift-list-backend:main
    restart: always
    environment:
      - DATABASE_URL=postgresql://giftlistuser:miaPasswordSicura@db:5432/giftlistdb
      - PORT=3000
      - CORS_ORIGIN=https://liste.edoardosarri.com
      # --- ECCO LA PARTE CHE CAMBIA ---
      # INSERISCI DI SEGUITO DIRETTAMENTE I TUOI VALORI VERI
      - JWT_SECRET=DquWtjmyokZOHxXCr6HGYiu/N6k3P+6Z
      - SMTP_HOST=localhost
      - SMTP_PORT=465
      - SMTP_USER=dummy
      - SMTP_PASS=dummy
    depends_on:
      - db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  db:
    image: postgres:17-alpine
    restart: always
    volumes:
      - NAS_DATABASE_DATA_V2:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=giftlistdb
      - POSTGRES_USER=giftlistuser
      - POSTGRES_PASSWORD=miaPasswordSicura
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  tunnel:
    image: cloudflare/cloudflared:latest
    restart: always
    # --- CAMBIA ANCHE QUESTA PARTE ---
    # Elimina "--token ${CLOUDFLARE_TOKEN}" e invece usa la variabile d'ambiente ufficiale
    command: tunnel run
    environment:
      # Sostituisci la scritta qui sotto con il token vero che inizia con eyJh...
      - TUNNEL_TOKEN=eyJhIjoiNjAxZGFlNDk1ODM0NzUyMjU4NjYwMzMwMWFiZGFlOTMiLCJ0IjoiNTY5YWI0NGYtZjA2My00ZGUzLTg3N2MtNWViZDg0MjlhZGQzIiwicyI6Ill6azRORE00WTJFdFltTmhOQzAwTUdVMkxXSXlORGt0TnpZM09EaGxOR0l6T1RWbCJ9
    depends_on:
      - frontend
      - api

  watchtower:
    image: containrrr/watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 300 frontend api

volumes:
  NAS_DATABASE_DATA_V2:
